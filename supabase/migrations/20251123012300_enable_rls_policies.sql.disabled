-- ================================================
-- Enable Row Level Security (RLS) Policies
-- LinkPitch MVP v8.6 - Security Layer
-- í˜„ì¬ ë¹„í™œì„±í™” ìƒíƒœ (.disabled) - í”„ë¡œë•ì…˜ ë°°í¬ ì‹œ í™œì„±í™”
-- ================================================

-- ================================================
-- 1. Enable RLS on all user data tables
-- ================================================

ALTER TABLE users ENABLE ROW LEVEL SECURITY;
ALTER TABLE prospects ENABLE ROW LEVEL SECURITY;
ALTER TABLE sequences ENABLE ROW LEVEL SECURITY;
ALTER TABLE step ENABLE ROW LEVEL SECURITY;
ALTER TABLE step_generations ENABLE ROW LEVEL SECURITY;
ALTER TABLE generated_emails ENABLE ROW LEVEL SECURITY;
ALTER TABLE user_assets ENABLE ROW LEVEL SECURITY;
ALTER TABLE report_tracking_logs ENABLE ROW LEVEL SECURITY;

-- plans, user_plans, step_templates, site_analysis_cacheëŠ” ê´€ë¦¬ì ì „ìš©ì´ë¯€ë¡œ RLS ë¶ˆí•„ìš”

-- ================================================
-- 2. Helper Function: Get Current User's UUID
-- ================================================

-- Clerk JWTì—ì„œ clerk_idë¥¼ ì¶”ì¶œí•˜ì—¬ users í…Œì´ë¸”ì˜ UUIDë¥¼ ë°˜í™˜
CREATE OR REPLACE FUNCTION public.current_user_id()
RETURNS UUID AS $$
  SELECT id FROM users
  WHERE clerk_id = auth.jwt()->>'sub'
  LIMIT 1;
$$ LANGUAGE SQL STABLE SECURITY DEFINER;

-- ================================================
-- 3. Users Table Policies
-- ================================================

-- ì‚¬ìš©ìëŠ” ìì‹ ì˜ ë ˆì½”ë“œë§Œ ì¡°íšŒ ê°€ëŠ¥
CREATE POLICY "users_select_own"
  ON users
  FOR SELECT
  USING (clerk_id = auth.jwt()->>'sub');

-- ìƒˆ ì‚¬ìš©ì ìƒì„± í—ˆìš© (íšŒì›ê°€ì… ì‹œ)
CREATE POLICY "users_insert_own"
  ON users
  FOR INSERT
  WITH CHECK (clerk_id = auth.jwt()->>'sub');

-- ì‚¬ìš©ìëŠ” ìì‹ ì˜ ë ˆì½”ë“œë§Œ ì—…ë°ì´íŠ¸ ê°€ëŠ¥ (í¬ë ˆë”§ ì°¨ê° ë“±)
CREATE POLICY "users_update_own"
  ON users
  FOR UPDATE
  USING (clerk_id = auth.jwt()->>'sub')
  WITH CHECK (clerk_id = auth.jwt()->>'sub');

-- ================================================
-- 4. Prospects Table Policies
-- ================================================

-- ì‚¬ìš©ìëŠ” ìì‹ ì´ ìƒì„±í•œ í”„ë¡œìŠ¤í™íŠ¸ë§Œ ì¡°íšŒ
CREATE POLICY "prospects_select_own"
  ON prospects
  FOR SELECT
  USING (user_id = public.current_user_id());

-- ì‚¬ìš©ìëŠ” ìì‹ ì˜ í”„ë¡œìŠ¤í™íŠ¸ë§Œ ìƒì„± ê°€ëŠ¥
CREATE POLICY "prospects_insert_own"
  ON prospects
  FOR INSERT
  WITH CHECK (user_id = public.current_user_id());

-- ì‚¬ìš©ìëŠ” ìì‹ ì˜ í”„ë¡œìŠ¤í™íŠ¸ë§Œ ì—…ë°ì´íŠ¸
CREATE POLICY "prospects_update_own"
  ON prospects
  FOR UPDATE
  USING (user_id = public.current_user_id())
  WITH CHECK (user_id = public.current_user_id());

-- ì‚¬ìš©ìëŠ” ìì‹ ì˜ í”„ë¡œìŠ¤í™íŠ¸ë§Œ ì‚­ì œ
CREATE POLICY "prospects_delete_own"
  ON prospects
  FOR DELETE
  USING (user_id = public.current_user_id());

-- ================================================
-- 5. Sequences Table Policies
-- ================================================

CREATE POLICY "sequences_select_own"
  ON sequences
  FOR SELECT
  USING (user_id = public.current_user_id());

CREATE POLICY "sequences_insert_own"
  ON sequences
  FOR INSERT
  WITH CHECK (user_id = public.current_user_id());

CREATE POLICY "sequences_update_own"
  ON sequences
  FOR UPDATE
  USING (user_id = public.current_user_id())
  WITH CHECK (user_id = public.current_user_id());

CREATE POLICY "sequences_delete_own"
  ON sequences
  FOR DELETE
  USING (user_id = public.current_user_id());

-- ================================================
-- 6. Step Table Policies
-- ================================================

CREATE POLICY "step_select_own"
  ON step
  FOR SELECT
  USING (user_id = public.current_user_id());

CREATE POLICY "step_insert_own"
  ON step
  FOR INSERT
  WITH CHECK (user_id = public.current_user_id());

CREATE POLICY "step_update_own"
  ON step
  FOR UPDATE
  USING (user_id = public.current_user_id())
  WITH CHECK (user_id = public.current_user_id());

CREATE POLICY "step_delete_own"
  ON step
  FOR DELETE
  USING (user_id = public.current_user_id());

-- ================================================
-- 7. Step Generations Table Policies
-- ================================================

CREATE POLICY "step_generations_select_own"
  ON step_generations
  FOR SELECT
  USING (user_id = public.current_user_id());

CREATE POLICY "step_generations_insert_own"
  ON step_generations
  FOR INSERT
  WITH CHECK (user_id = public.current_user_id());

CREATE POLICY "step_generations_update_own"
  ON step_generations
  FOR UPDATE
  USING (user_id = public.current_user_id())
  WITH CHECK (user_id = public.current_user_id());

CREATE POLICY "step_generations_delete_own"
  ON step_generations
  FOR DELETE
  USING (user_id = public.current_user_id());

-- ================================================
-- 8. Generated Emails Table Policies
-- ================================================

CREATE POLICY "generated_emails_select_own"
  ON generated_emails
  FOR SELECT
  USING (user_id = public.current_user_id());

CREATE POLICY "generated_emails_insert_own"
  ON generated_emails
  FOR INSERT
  WITH CHECK (user_id = public.current_user_id());

CREATE POLICY "generated_emails_update_own"
  ON generated_emails
  FOR UPDATE
  USING (user_id = public.current_user_id())
  WITH CHECK (user_id = public.current_user_id());

CREATE POLICY "generated_emails_delete_own"
  ON generated_emails
  FOR DELETE
  USING (user_id = public.current_user_id());

-- ================================================
-- 9. User Assets Table Policies
-- ================================================

CREATE POLICY "user_assets_select_own"
  ON user_assets
  FOR SELECT
  USING (user_id = public.current_user_id());

CREATE POLICY "user_assets_insert_own"
  ON user_assets
  FOR INSERT
  WITH CHECK (user_id = public.current_user_id());

CREATE POLICY "user_assets_update_own"
  ON user_assets
  FOR UPDATE
  USING (user_id = public.current_user_id())
  WITH CHECK (user_id = public.current_user_id());

CREATE POLICY "user_assets_delete_own"
  ON user_assets
  FOR DELETE
  USING (user_id = public.current_user_id());

-- ================================================
-- 10. Report Tracking Logs Table Policies
-- ================================================

-- ë¦¬í¬íŠ¸ ì¶”ì  ë¡œê·¸ëŠ” í”„ë¡œìŠ¤í™íŠ¸ ì†Œìœ ìë§Œ ì¡°íšŒ ê°€ëŠ¥
CREATE POLICY "report_tracking_logs_select_own"
  ON report_tracking_logs
  FOR SELECT
  USING (
    prospect_id IN (
      SELECT id FROM prospects WHERE user_id = public.current_user_id()
    )
  );

-- ë¦¬í¬íŠ¸ ì¶”ì  ë¡œê·¸ëŠ” ëˆ„êµ¬ë‚˜ ì‚½ì… ê°€ëŠ¥ (ìµëª… ì¶”ì  í—ˆìš©)
-- ë‹¨, prospect_idëŠ” ìœ íš¨í•œ í”„ë¡œìŠ¤í™íŠ¸ì—¬ì•¼ í•¨
CREATE POLICY "report_tracking_logs_insert_own"
  ON report_tracking_logs
  FOR INSERT
  WITH CHECK (
    prospect_id IN (
      SELECT id FROM prospects WHERE user_id = public.current_user_id()
    )
  );

-- ================================================
-- Completion Message
-- ================================================

DO $$
BEGIN
    RAISE NOTICE 'âœ… RLS Policies enabled successfully!';
    RAISE NOTICE 'ğŸ”’ Tables protected: users, prospects, sequences, step, step_generations, generated_emails, user_assets, report_tracking_logs';
    RAISE NOTICE 'ğŸ‘¤ Policy type: User owns their own data (user_id based)';
    RAISE NOTICE 'ğŸ”‘ Authentication: Clerk JWT integration via public.current_user_id()';
    RAISE NOTICE 'âš ï¸  Note: This file is currently disabled. Remove .disabled extension to activate.';
END $$;
