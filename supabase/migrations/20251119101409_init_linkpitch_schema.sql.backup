DROP TABLE "users";

CREATE TABLE "users" (
	"id"	UUID	DEFAULT gen_random_uuid()	NOT NULL,
	"clerk_id"	text	DEFAULT UNIQUE	NOT NULL,
	"email"	VARCHAR(255)		NOT NULL,
	"name"	VARCHAR(255)		NULL,
	"created_at"	timestamptz	DEFAULT now()	NOT NULL,
	"updated_at"	timestamptz	DEFAULT now()	NOT NULL
);

COMMENT ON COLUMN "users"."id" IS '사용자 고유 ID';

COMMENT ON COLUMN "users"."clerk_id" IS 'clerk아이디';

COMMENT ON COLUMN "users"."email" IS '사용자 이메일';

COMMENT ON COLUMN "users"."name" IS '사용자 이름';

COMMENT ON COLUMN "users"."created_at" IS '가입일시';

COMMENT ON COLUMN "users"."updated_at" IS '수정일시';

DROP TABLE "step";

CREATE TABLE "step" (
	"id"	UUID	DEFAULT gen_random_uuid()	NOT NULL,
	"user_id"	UUID		NOT NULL,
	"sequence_id"	UUID		NOT NULL,
	"step_number"	INT		NOT NULL,
	"step_type"	VARCHAR(100)		NULL,
	"email_subject"	VARCHAR(255)		NULL,
	"email_body"	TEXT		NULL,
	"status"	VARCHAR(50)	DEFAULT 'pending'	NOT NULL,
	"recommended_send_at"	timestamptz		NULL,
	"sent_at"	timestamptz		NULL,
	"is_replied"	BOOLEAN	DEFAULT false	NOT NULL,
	"replied_at"	timestamptz		NULL,
	"has_clicked_report"	BOOLEAN	DEFAULT false	NOT NULL,
	"report_engagement_level"	VARCHAR(50)	DEFAULT 'none'	NOT NULL,
	"last_report_view_seconds"	INT		NULL,
	"last_report_scroll_depth"	INT		NULL,
	"created_at"	timestamptz	DEFAULT now()	NOT NULL,
	"updated_at"	timestamptz	DEFAULT now()	NOT NULL
);

COMMENT ON COLUMN "step"."id" IS '스텝 ID';

COMMENT ON COLUMN "step"."user_id" IS '사용자 고유 ID';

COMMENT ON COLUMN "step"."sequence_id" IS '시퀀스 ID';

COMMENT ON COLUMN "step"."step_number" IS '스텝 번호';

COMMENT ON COLUMN "step"."step_type" IS '스텝 타입';

COMMENT ON COLUMN "step"."email_subject" IS '이메일 제목';

COMMENT ON COLUMN "step"."email_body" IS '이메일 본문';

COMMENT ON COLUMN "step"."status" IS '상태';

COMMENT ON COLUMN "step"."recommended_send_at" IS '권장 발송시간';

COMMENT ON COLUMN "step"."sent_at" IS '실제 발송시간';

COMMENT ON COLUMN "step"."is_replied" IS '답장 여부';

COMMENT ON COLUMN "step"."replied_at" IS '답장 시간';

COMMENT ON COLUMN "step"."has_clicked_report" IS '리포트 클릭 여부';

COMMENT ON COLUMN "step"."report_engagement_level" IS '참여도 레벨';

COMMENT ON COLUMN "step"."last_report_view_seconds" IS '리포트 본 시간';

COMMENT ON COLUMN "step"."last_report_scroll_depth" IS '스크롤 깊이';

COMMENT ON COLUMN "step"."created_at" IS '생성일';

COMMENT ON COLUMN "step"."updated_at" IS '수정일';

DROP TABLE "reports";

CREATE TABLE "reports" (
	"id"	UUID	DEFAULT gen_random_uuid()	NOT NULL,
	"user_id"	UUID		NOT NULL,
	"step_id"	UUID		NOT NULL,
	"report_json"	JSON		NOT NULL,
	"created_at"	timestamptz	DEFAULT now()	NOT NULL,
	"updated_at"	timestamptz	DEFAULT now()	NOT NULL
);

COMMENT ON COLUMN "reports"."id" IS '리포트 ID';

COMMENT ON COLUMN "reports"."user_id" IS '사용자 고유 ID';

COMMENT ON COLUMN "reports"."step_id" IS '스텝 ID';

COMMENT ON COLUMN "reports"."report_json" IS '리포트 JSON 데이터';

COMMENT ON COLUMN "reports"."created_at" IS '생성일시';

COMMENT ON COLUMN "reports"."updated_at" IS '수정일시';

DROP TABLE "user_plans";

CREATE TABLE "user_plans" (
	"id"	UUID	DEFAULT gen_random_uuid()	NOT NULL,
	"user_id"	UUID		NOT NULL,
	"plan_id"	UUID		NOT NULL,
	"is_current"	BOOLEAN	DEFAULT true	NOT NULL,
	"started_at"	timestamptz	DEFAULT now()	NOT NULL,
	"ended_at"	timestamptz		NULL,
	"note"	TEXT		NULL,
	"created_at"	timestamptz	DEFAULT now()	NOT NULL,
	"updated_at"	timestamptz	DEFAULT now()	NOT NULL
);

COMMENT ON COLUMN "user_plans"."id" IS '구독 기록 ID';

COMMENT ON COLUMN "user_plans"."user_id" IS '사용자 고유 ID';

COMMENT ON COLUMN "user_plans"."plan_id" IS '플랜 ID';

COMMENT ON COLUMN "user_plans"."is_current" IS '현재 활성 여부';

COMMENT ON COLUMN "user_plans"."started_at" IS '시작일';

COMMENT ON COLUMN "user_plans"."ended_at" IS '종료일';

COMMENT ON COLUMN "user_plans"."note" IS '비고';

COMMENT ON COLUMN "user_plans"."created_at" IS '생성일시';

COMMENT ON COLUMN "user_plans"."updated_at" IS '수정일시';

DROP TABLE "sequences";

CREATE TABLE "sequences" (
	"id"	UUID	DEFAULT gen_random_uuid()	NOT NULL,
	"user_id"	UUID		NOT NULL,
	"prospect_id"	UUID		NOT NULL,
	"name"	VARCHAR(255)		NULL,
	"sequence_type"	VARCHAR(100)		NOT NULL,
	"total_steps"	INT		NULL,
	"current_step"	INT	DEFAULT 0	NOT NULL,
	"status"	VARCHAR(50)	DEFAULT 'draft'	NOT NULL,
	"created_at"	timestamptz	DEFAULT now()	NOT NULL,
	"updated_at"	timestamptz	DEFAULT now()	NOT NULL
);

COMMENT ON COLUMN "sequences"."id" IS '시퀀스 ID';

COMMENT ON COLUMN "sequences"."user_id" IS '사용자 고유 ID';

COMMENT ON COLUMN "sequences"."prospect_id" IS '고객사 ID';

COMMENT ON COLUMN "sequences"."name" IS '캠페인명';

COMMENT ON COLUMN "sequences"."sequence_type" IS '시퀀스 타입';

COMMENT ON COLUMN "sequences"."total_steps" IS '총 스텝 수';

COMMENT ON COLUMN "sequences"."current_step" IS '현재 스텝';

COMMENT ON COLUMN "sequences"."status" IS '상태';

COMMENT ON COLUMN "sequences"."created_at" IS '생성일시';

COMMENT ON COLUMN "sequences"."updated_at" IS '수정일시';

DROP TABLE "plans";

CREATE TABLE "plans" (
	"id"	UUID		NOT NULL,
	"code"	VARCHAR(50)		NOT NULL,
	"name"	VARCHAR(255)		NOT NULL,
	"description"	TEXT		NULL,
	"monthly_quota"	INT		NOT NULL,
	"price_krw"	INT		NOT NULL,
	"is_active"	BOOLEAN		NOT NULL,
	"created_at"	timestamptz	DEFAULT now()	NOT NULL
);

COMMENT ON COLUMN "plans"."code" IS '플랜 코드';

COMMENT ON COLUMN "plans"."name" IS '플랜명';

COMMENT ON COLUMN "plans"."description" IS '플랜 설명';

COMMENT ON COLUMN "plans"."monthly_quota" IS '월 발송 한도';

COMMENT ON COLUMN "plans"."price_krw" IS '월 가격(원)';

COMMENT ON COLUMN "plans"."is_active" IS '활성화 여부';

COMMENT ON COLUMN "plans"."created_at" IS '생성일시';

DROP TABLE "generation_logs";

CREATE TABLE "generation_logs" (
	"id"	UUID	DEFAULT gen_random_uuid()	NOT NULL,
	"user_id"	UUID		NOT NULL,
	"prospect_id"	UUID		NOT NULL,
	"step_id"	UUID		NOT NULL,
	"step_type"	VARCHAR(100)		NULL,
	"input_payload"	JSON		NOT NULL,
	"output_insights"	JSON		NULL,
	"output_email_subject"	VARCHAR(255)		NULL,
	"output_email_body"	LONGTEXT		NULL,
	"created_at"	timestamptz	DEFAULT now()	NOT NULL
);

COMMENT ON COLUMN "generation_logs"."id" IS 'AI 생성 로그 ID';

COMMENT ON COLUMN "generation_logs"."user_id" IS '사용자 고유 ID';

COMMENT ON COLUMN "generation_logs"."prospect_id" IS '고객사 ID';

COMMENT ON COLUMN "generation_logs"."step_id" IS '스텝 ID';

COMMENT ON COLUMN "generation_logs"."step_type" IS '스텝 타입';

COMMENT ON COLUMN "generation_logs"."input_payload" IS '입력 데이터';

COMMENT ON COLUMN "generation_logs"."output_insights" IS 'AI 출력 인사이트';

COMMENT ON COLUMN "generation_logs"."output_email_subject" IS '생성 제목';

COMMENT ON COLUMN "generation_logs"."output_email_body" IS '생성 본문';

COMMENT ON COLUMN "generation_logs"."created_at" IS '생성일시';

DROP TABLE "report_events";

CREATE TABLE "report_events" (
	"id"	UUID	DEFAULT gen_random_uuid()	NOT NULL,
	"user_id"	UUID		NOT NULL,
	"step_id"	UUID		NOT NULL,
	"report_id"	UUID		NOT NULL,
	"dwell_seconds"	INT		NULL,
	"scroll_depth"	INT		NULL,
	"interacted"	BOOLEAN	DEFAULT false	NOT NULL,
	"created_at"	timestamptz	DEFAULT now()	NOT NULL
);

COMMENT ON COLUMN "report_events"."id" IS '리포트 이벤트 ID';

COMMENT ON COLUMN "report_events"."user_id" IS '사용자 고유 ID';

COMMENT ON COLUMN "report_events"."step_id" IS '스텝 ID';

COMMENT ON COLUMN "report_events"."report_id" IS '리포트 ID';

COMMENT ON COLUMN "report_events"."dwell_seconds" IS '머문 시간(초)';

COMMENT ON COLUMN "report_events"."scroll_depth" IS '스크롤 깊이(%)';

COMMENT ON COLUMN "report_events"."interacted" IS '상호작용 여부';

COMMENT ON COLUMN "report_events"."created_at" IS '이벤트 시간';

DROP TABLE "prospects";

CREATE TABLE "prospects" (
	"id"	UUID	DEFAULT gen_random_uuid()	NOT NULL,
	"user_id"	UUID		NOT NULL,
	"name"	VARCHAR(255)		NOT NULL,
	"contact_name"	VARCHAR(255)		NULL,
	"contact_email"	VARCHAR(255)		NULL,
	"url"	VARCHAR(500)		NOT NULL,
	"memo"	TEXT		NULL,
	"created_at"	timestamptz	DEFAULT now()	NOT NULL,
	"updated_at"	timestamptz	DEFAULT now()	NOT NULL
);

COMMENT ON COLUMN "prospects"."id" IS '고객사 ID';

COMMENT ON COLUMN "prospects"."user_id" IS '사용자 고유 ID';

COMMENT ON COLUMN "prospects"."name" IS '회사명/스토어명';

COMMENT ON COLUMN "prospects"."contact_name" IS '담당자 이름';

COMMENT ON COLUMN "prospects"."contact_email" IS '담당자 이메일';

COMMENT ON COLUMN "prospects"."url" IS '웹사이트 URL';

COMMENT ON COLUMN "prospects"."memo" IS '메모';

COMMENT ON COLUMN "prospects"."created_at" IS '생성일시';

COMMENT ON COLUMN "prospects"."updated_at" IS '수정일시';

DROP TABLE "step_drafts";

CREATE TABLE "step_drafts" (
	"id"	UUID	DEFAULT gen_random_uuid()	NOT NULL,
	"user_id"	UUID		NOT NULL,
	"sequence_id"	UUID		NOT NULL,
	"prospect_id"	UUID		NOT NULL,
	"step_number"	INT		NOT NULL,
	"step_type"	VARCHAR(100)		NULL,
	"version_number"	INT		NOT NULL,
	"email_subject"	VARCHAR(255)		NULL,
	"email_body"	LONGTEXT		NULL,
	"insights_json"	JSON		NULL,
	"report_json"	JSON		NULL,
	"is_selected"	BOOLEAN	DEFAULT false	NOT NULL,
	"selected_at"	timestamptz		NULL,
	"generation_log_id"	UUID		NULL,
	"input_payload"	JSON		NULL,
	"expires_at"	timestamptz		NULL,
	"updated_at"	timestamptz	DEFAULT now()	NOT NULL,
	"created_at"	timestamptz	DEFAULT now()	NOT NULL
);

COMMENT ON COLUMN "step_drafts"."id" IS '스텝 ID';

COMMENT ON COLUMN "step_drafts"."user_id" IS '사용자 고유 ID';

COMMENT ON COLUMN "step_drafts"."sequence_id" IS '시퀀스 ID';

COMMENT ON COLUMN "step_drafts"."prospect_id" IS '고객사 ID';

COMMENT ON COLUMN "step_drafts"."step_number" IS '스텝 번호';

COMMENT ON COLUMN "step_drafts"."step_type" IS '스텝 타입';

COMMENT ON COLUMN "step_drafts"."version_number" IS '버전 번호';

COMMENT ON COLUMN "step_drafts"."email_subject" IS '이메일 제목';

COMMENT ON COLUMN "step_drafts"."email_body" IS '이메일 본문';

COMMENT ON COLUMN "step_drafts"."insights_json" IS '이메일/고객 인사이트';

COMMENT ON COLUMN "step_drafts"."report_json" IS '분석 리포트 데이터';

COMMENT ON COLUMN "step_drafts"."is_selected" IS '선택 여부';

COMMENT ON COLUMN "step_drafts"."selected_at" IS '선택한 시간';

COMMENT ON COLUMN "step_drafts"."generation_log_id" IS '생성 로그 ID';

COMMENT ON COLUMN "step_drafts"."input_payload" IS '생성 입력 데이터';

COMMENT ON COLUMN "step_drafts"."expires_at" IS '만료 시간';

COMMENT ON COLUMN "step_drafts"."updated_at" IS '수정일';

COMMENT ON COLUMN "step_drafts"."created_at" IS '생성일';

ALTER TABLE "users" ADD CONSTRAINT "PK_USERS" PRIMARY KEY (
	"id"
);

ALTER TABLE "step" ADD CONSTRAINT "PK_STEP" PRIMARY KEY (
	"id"
);

ALTER TABLE "reports" ADD CONSTRAINT "PK_REPORTS" PRIMARY KEY (
	"id"
);

ALTER TABLE "user_plans" ADD CONSTRAINT "PK_USER_PLANS" PRIMARY KEY (
	"id"
);

ALTER TABLE "sequences" ADD CONSTRAINT "PK_SEQUENCES" PRIMARY KEY (
	"id"
);

ALTER TABLE "plans" ADD CONSTRAINT "PK_PLANS" PRIMARY KEY (
	"id"
);

ALTER TABLE "generation_logs" ADD CONSTRAINT "PK_GENERATION_LOGS" PRIMARY KEY (
	"id"
);

ALTER TABLE "report_events" ADD CONSTRAINT "PK_REPORT_EVENTS" PRIMARY KEY (
	"id"
);

ALTER TABLE "prospects" ADD CONSTRAINT "PK_PROSPECTS" PRIMARY KEY (
	"id"
);

ALTER TABLE "step_drafts" ADD CONSTRAINT "PK_STEP_DRAFTS" PRIMARY KEY (
	"id"
);

ALTER TABLE "step" ADD CONSTRAINT "FK_users_TO_step_1" FOREIGN KEY (
	"user_id"
)
REFERENCES "users" (
	"id"
);

ALTER TABLE "step" ADD CONSTRAINT "FK_sequences_TO_step_1" FOREIGN KEY (
	"sequence_id"
)
REFERENCES "sequences" (
	"id"
);

ALTER TABLE "reports" ADD CONSTRAINT "FK_users_TO_reports_1" FOREIGN KEY (
	"user_id"
)
REFERENCES "users" (
	"id"
);

ALTER TABLE "reports" ADD CONSTRAINT "FK_step_TO_reports_1" FOREIGN KEY (
	"step_id"
)
REFERENCES "step" (
	"id"
);

ALTER TABLE "user_plans" ADD CONSTRAINT "FK_users_TO_user_plans_1" FOREIGN KEY (
	"user_id"
)
REFERENCES "users" (
	"id"
);

ALTER TABLE "user_plans" ADD CONSTRAINT "FK_plans_TO_user_plans_1" FOREIGN KEY (
	"plan_id"
)
REFERENCES "plans" (
	"id"
);

ALTER TABLE "sequences" ADD CONSTRAINT "FK_users_TO_sequences_1" FOREIGN KEY (
	"user_id"
)
REFERENCES "users" (
	"id"
);

ALTER TABLE "sequences" ADD CONSTRAINT "FK_prospects_TO_sequences_1" FOREIGN KEY (
	"prospect_id"
)
REFERENCES "prospects" (
	"id"
);

ALTER TABLE "generation_logs" ADD CONSTRAINT "FK_users_TO_generation_logs_1" FOREIGN KEY (
	"user_id"
)
REFERENCES "users" (
	"id"
);

ALTER TABLE "generation_logs" ADD CONSTRAINT "FK_prospects_TO_generation_logs_1" FOREIGN KEY (
	"prospect_id"
)
REFERENCES "prospects" (
	"id"
);

ALTER TABLE "generation_logs" ADD CONSTRAINT "FK_step_TO_generation_logs_1" FOREIGN KEY (
	"step_id"
)
REFERENCES "step" (
	"id"
);

ALTER TABLE "report_events" ADD CONSTRAINT "FK_users_TO_report_events_1" FOREIGN KEY (
	"user_id"
)
REFERENCES "users" (
	"id"
);

ALTER TABLE "report_events" ADD CONSTRAINT "FK_step_TO_report_events_1" FOREIGN KEY (
	"step_id"
)
REFERENCES "step" (
	"id"
);

ALTER TABLE "report_events" ADD CONSTRAINT "FK_reports_TO_report_events_1" FOREIGN KEY (
	"report_id"
)
REFERENCES "reports" (
	"id"
);

ALTER TABLE "prospects" ADD CONSTRAINT "FK_users_TO_prospects_1" FOREIGN KEY (
	"user_id"
)
REFERENCES "users" (
	"id"
);

ALTER TABLE "step_drafts" ADD CONSTRAINT "FK_users_TO_step_drafts_1" FOREIGN KEY (
	"user_id"
)
REFERENCES "users" (
	"id"
);

ALTER TABLE "step_drafts" ADD CONSTRAINT "FK_sequences_TO_step_drafts_1" FOREIGN KEY (
	"sequence_id"
)
REFERENCES "sequences" (
	"id"
);

ALTER TABLE "step_drafts" ADD CONSTRAINT "FK_prospects_TO_step_drafts_1" FOREIGN KEY (
	"prospect_id"
)
REFERENCES "prospects" (
	"id"
);

