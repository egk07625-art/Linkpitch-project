# Supabase Database Rules

## 마이그레이션 규칙

### 파일 명명
- 형식: `YYYYMMDDHHmmss_description.sql`
- 예시: `20241030014800_create_users_table.sql`

### 마이그레이션 작성 원칙
- 한 번에 하나의 변경사항만
- 롤백 가능한 구조로 작성
- 주석으로 변경 이유 명시

## RLS (Row Level Security)

### 현재 상태
- **개발 중**: RLS 비활성화
- **프로덕션**: 반드시 활성화 필수

### RLS 정책 작성
- select, insert, update, delete별로 각각 작성
- Clerk JWT의 `sub` claim을 `user_id`로 매칭
- 정책은 주석으로 작성해두고 출시 전 활성화

### 예시
```sql
-- RLS 활성화 (출시 전에 주석 해제)
-- ALTER TABLE users ENABLE ROW LEVEL SECURITY;

-- SELECT 정책
-- CREATE POLICY "Users can view own data"
-- ON users FOR SELECT
-- USING (auth.jwt()->>'sub' = clerk_id::text);
```

## 테이블 설계

### 기본 컬럼
- `id`: UUID (Primary Key)
- `created_at`: TIMESTAMP
- `updated_at`: TIMESTAMP

### 사용자 연결
- `user_id`: UUID (FK → users.id)
- 또는 `clerk_id`: TEXT (Clerk User ID 직접 참조)

## Storage 버킷

### 버킷 구조
- `app-assets`: 사용자 파일 저장소
- 경로: `{clerk_user_id}/{filename}`

### RLS 정책
- INSERT: 인증된 사용자만 자신의 폴더에 업로드
- SELECT: 인증된 사용자만 자신의 파일 조회
- DELETE: 인증된 사용자만 자신의 파일 삭제
- UPDATE: 인증된 사용자만 자신의 파일 업데이트

## Supabase 클라이언트 사용

### 환경별 클라이언트
- `clerk-client.ts`: Client Component용
- `server.ts`: Server Component/Server Action용
- `service-role.ts`: 관리자 권한 작업용
- `client.ts`: 인증 불필요한 공개 데이터용

### 인증 통합
- Clerk 토큰을 Supabase 인증으로 사용
- JWT 템플릿 불필요 (네이티브 통합)
